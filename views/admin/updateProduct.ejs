<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Update Product - MODMEN Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.5.16/dist/cropper.min.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <!-- REMOVE one of the duplicate SweetAlert2 includes and keep just one -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

 <style>
  body { background: #f7f7fa; font-family: "Inter", Arial, sans-serif; }
  .section-card { border-radius: 18px; border: 1.5px solid #2196f3; background: #fff; box-shadow: 0 5px 24px #729df511; margin-bottom: 32px;}
  .section-title { font-weight: 600; font-size: 1.18rem; color: #222; padding-top: 16px; padding-bottom: 7px; }
  .form-label { color: #535353; font-size: 1rem;}

  .image-uploader-zone {
    max-width: 390px;
    margin: 0 auto;
    padding: 18px 10px;
    border-radius: 14px;
    box-shadow: 0 3px 8px rgba(33,150,243,.15);
    background: #f9fbff;
    border: 2px dashed #d4dbed;
  }

  .image-uploader-zone img {
    height: 200px;
    width: 100%;
    object-fit: contain;
    border-radius: 10px;
    background: #e8ecf6;
    display: block;
    margin: auto;
  }

  .image-holder-row { justify-content: center; gap: 18px; }
  .image-holder-col { flex: 0 0 29%; max-width: 29%; }

  .image-add-btn {
    color: #2563eb;
    border: none;
    background: #e6eaf7;
    padding: 10px 0;
    border-radius: 8px;
    width: 100%;
  }
  .image-add-btn:hover { background: #2563eb; color: #fff; }

  .variant-table-row { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; margin-left: 10px;}
  .variant-table-row .size-label { width: 32px; margin-right: 20px; font-weight: 500; color: #161d22; flex-shrink: 0; }
  .variant-table-row .qty-input { width: 65px; border-radius: 6px !important; background: #f1f3fa !important; border: 1.3px solid #dde4f0; }
  .variant-table-row .price-input { width: 75px; border-radius: 6px !important; background: #f1f3fa !important; border: 1.3px solid #dde4f0; margin-left: 10px; }
  .variant-table-header { display: flex; gap: 20px; font-weight: 600; color: #777; margin-bottom: 6px; margin-left: 42px;}
  .variant-table-header .header-cell { width: 65px; text-align: left; margin-right: 15px; }
  .variant-table-header .header-cell.price { width: 75px; }

  /* CROP MODAL â€” FULL OPAQUE, NO TRANSPARENCY */
  .cropper-modal {
    display: none;
    position: fixed;
    z-index: 99999;
    inset: 0;
    background: rgba(0,0,0,0.88) !important;
    align-items: center;
    justify-content: center;
  }

  .cropper-modal-content {
    background: #ffffff !important;
    border-radius: 14px;
    padding: 32px 24px;
    min-width: 420px;
    max-width: 95vw;
    max-height: 95vh;
    box-shadow: 0 8px 28px rgba(0,0,0,0.35);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }

  .modal-close {
    position: absolute;
    top: 12px;
    right: 18px;
    font-size: 2rem;
    cursor: pointer;
    color: #444;
  }

  #cropperImage {
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
    background: #fff !important;
  }

  /* ðŸ”¥ REAL FIX â€” Remove transparency inside cropper canvas */
  .cropper-container,
  .cropper-wrap-box,
  .cropper-canvas,
  .cropper-crop-box,
  .cropper-bg {
    background-color: #ffffff !important;
  }

  /* Ensures no shadow or transparent layer from cropper */
  .cropper-bg {
    opacity: 1 !important;
  }

  .cropper-btn-row {
    margin-top: 10px;
    margin-bottom: 10px;
    display: flex;
    gap: 20px;
    position: relative;
    top: -10px;
  }

  .error-text { color: #d32f2f; font-size: .95rem; display: none; }

  @media (max-width: 600px) {
    .image-holder-row { flex-direction: column; gap: 12px; }
    .cropper-modal-content { min-width: 320px; }
    .image-uploader-zone img { height: 160px; }
    #cropperImage { max-width: 90vw; max-height: 70vh; }
  }
</style>

</head>
<body>
  <%- include('../partials/admin/header') %>
  <div class="container-fluid">
    <div class="row">
      <%- include('../partials/admin/sidebar') %>
      <main class="col-md-9 ms-sm-auto col-lg-10 p-4">

        <% if (error_msg && error_msg.length > 0) { %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <%= error_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        <% } %>

        <% if (success_msg && success_msg.length > 0) { %>
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= success_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        <% } %>

        <form novalidate id="updateProductForm" 
          method="POST" 
          enctype="multipart/form-data" 
          action="/admin/updateProduct/<%= product._id %>?_method=PATCH">
          
          <!-- General Info -->
          <div class="section-card p-3 px-md-4">
            <div class="section-title">General Information</div>
            <div class="mb-2">
              <label class="form-label">Product Name</label>
              <input type="text" class="form-control" name="name" id="name" required value="<%= product.name %>">
              <div id="nameError" class="text-danger small"></div>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" id="description" rows="2" required><%= product.description %></textarea>
              <div id="descriptionError" class="text-danger small"></div>
            </div>
            <div class="row mb-3 align-items-center">
              <div class="col-md-5">
                <label class="form-label">Tags</label>
                <input type="text" class="form-control" name="tags" placeholder="t-shirt, summer, menswear" value="<%= product.tags ? product.tags.join(', ') : '' %>">
              </div>
              <div class="col-md-4">
                <span class="form-label me-2">Should be</span>
                <label class="me-2"><input type="radio" name="isListed" value="true" <%= product.isListed ? 'checked' : '' %>> Listed</label>
                <label><input type="radio" name="isListed" value="false" <%= !product.isListed ? 'checked' : '' %>> Unlisted</label>
              </div>
              <div class="col-md-1">
                <label class="form-label">Product Offer %</label>
                <input type="number" name="offer.productOffer" id="productOffer" class="form-control" placeholder="%" value="<%= product.offer?.productOffer || '' %>">
                <div id="offerPercentError" class="text-danger small"></div>
              </div>
              <div class="col-md-2">
                <label class="form-label">Max Redeem</label>
                <input type="number" name="offer.maxRedeem" id="maxRedeem" class="form-control" placeholder="Max Redeem" value="<%= product.offer?.maxRedeem || '' %>">
              <div id="maxRedeemError" class="text-danger small"></div>
              </div>
            </div>
          </div>

          <!-- Images -->
<div class="section-card px-3">
  <div class="section-title">PRODUCT IMAGES</div>

  <!-- MAIN IMAGE -->
  <div class="mb-2" style="font-size:.98em;color:#767676;">Main Photo</div>
  <div class="image-uploader-zone mb-3 py-3 position-relative">

    <img id="mainImagePreview"
         src="<%= product.images[0]?.url || 'https://dummyimage.com/420x140/e8eaf5/b8bdde.jpg&text=No+Image' %>" 
         alt="Main Photo">

    <button type="button" class="image-add-btn mt-2" onclick="openInput(0)">Change Image</button>

    <% if (product.images[0]) { %>
      <button type="button"
              class="btn btn-danger btn-sm position-absolute"
              style="top:5px; right:5px;"
              onclick="deleteImage('<%= product._id %>', 0)">
        Delete
      </button>
    <% } %>

    <input type="file" name="images" id="mainImageInput" accept="image/*" style="display:none">
    <input type="hidden" name="croppedImages[]" id="mainCroppedImageData" value="">
  </div>

  <!-- ADDITIONAL IMAGES -->
  <div class="mb-2" style="font-size:.98em;color:#767676;">Additional</div>
  <div class="row image-holder-row">

    <% for (let i = 1; i < 4; i++) { %>
      <div class="image-holder-col">
        <div class="image-uploader-zone py-3 position-relative">

          <img id="additionalImagePreview<%= i %>"
               src="<%= product.images[i]?.url || 'https://dummyimage.com/170x140/e8eaf5/b8bdde.jpg&text=No+Image' %>"
               alt="Additional <%= i %>">

          <button type="button" class="image-add-btn mt-2" onclick="openInput(<%= i %>)">Change Image</button>

          <% if (product.images[i]) { %>
            <button type="button"
                    class="btn btn-danger btn-sm position-absolute"
                    style="top:5px; right:5px;"
                    onclick="deleteImage('<%= product._id %>', <%= i %>)">
              Delete
            </button>
          <% } %>

          <input type="file" name="images" id="additionalImageInput<%= i %>" accept="image/*" style="display:none">
          <input type="hidden" name="croppedImages[]" id="additionalCroppedImageData<%= i %>" value="">
        </div>
      </div>
    <% } %>

  </div>

  <div id="imageError" class="error-text mt-2" style="display:none;">
    Please crop the selected images before submitting.
  </div>
</div>

          <!-- Category & Variants -->
          <div class="section-card p-3 px-md-4">
            <div class="row">
              <div class="col-md-5">
                <div class="mb-3">
                  <label class="form-label">Select Category</label>
                  <select class="form-select" id="categorySelect" name="categoryId" required>
                    <option value="">-- Select Category --</option>
                    <% categories.forEach(function(cat) { %>
                      <option value="<%= cat._id %>" <%= product.categoryId?.toString() === cat._id.toString() ? 'selected' : '' %>><%= cat.name %></option>
                    <% }) %>
                  </select>
                  <div id="categoryError" class="text-danger small"></div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Select Subcategory</label>
                  <select class="form-select" id="subcategorySelect" name="subCategoryId">
                    <option value="">-- Select Subcategory --</option>
                    <% subcategories.forEach(function(sub) { %>
                      <option value="<%= sub._id %>" data-category-id="<%= sub.category.toString() %>" <%= product.subCategoryId?.toString() === sub._id.toString() ? 'selected' : '' %>>
                        <%= sub.name %>
                      </option>
                    <% }) %>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Color</label>
                  <input type="text" class="form-control" name="color" id="color" required value="<%= product.color %>">
                  <div id="colorError" class="text-danger small"></div>
                </div>

                <div class="mb-3">
                  <label class="form-label">SKU (auto-generated)</label>
                  <input type="text" class="form-control" name="sku" readonly value="<%= product.variants && product.variants.length > 0 ? product.variants[0].sku : '' %>">
                </div>
              </div>

              <div class="col-md-7">
                <div class="mb-2" style="font-weight:500;">Size, Qty & Price</div>
                <div class="variant-table-header">
                  <div class="size-label"></div>
                  <div class="header-cell">Qty</div>
                  <div class="header-cell price">Price</div>
                </div>
                <% let sizes = ['S','M','L','XL']; %>
                <% for(let i=0; i<sizes.length; i++){ 
                  const size = sizes[i];
                  const variant = product.variants.find(v => v.size === size) || {};
                %>
                  <div class="variant-table-row">
                    <div class="size-label"><%= size %></div>
                    <input type="number" name="qty[<%= size %>]" class="form-control qty-input" placeholder="Qty" value="<%= variant.variantQuantity || '' %>">
                    <input type="number" name="price[<%= size %>]" class="form-control price-input" placeholder="Price" value="<%= variant.variantPrice || '' %>">
                  </div>
                <% } %>
              </div>
              <div id="variantError" class="text-danger small"></div>
            </div>
          </div>

          <!-- Product Specifications -->
          <div class="section-card p-3 px-md-4">
            <div class="section-title">Product Specifications</div>
            <div class="mb-2">
              <label class="form-label">Fit Type</label>
              <select class="form-select" name="fitType" id="fitType">
                <option value="">Select Fit Type</option>
                <option value="Regular Fit" <%= product.fitType === "Regular Fit" ? "selected" : "" %>>Regular Fit</option>
                <option value="Slim Fit" <%= product.fitType === "Slim Fit" ? "selected" : "" %>>Slim Fit</option>
                <option value="Relaxed Fit" <%= product.fitType === "Relaxed Fit" ? "selected" : "" %>>Relaxed Fit</option>
              </select>
              <div id="fitTypeError" class="text-danger small"></div>
            </div>

            <div class="mb-2">
              <label class="form-label">Sleeve Type</label>
              <select class="form-select" name="sleeveType" id="sleeveType">
                <option value="">Select Sleeve Type</option>
                <option value="Full Sleeve" <%= product.sleeveType === "Full Sleeve" ? "selected" : "" %>>Full Sleeve</option>
                <option value="Half Sleeve" <%= product.sleeveType === "Half Sleeve" ? "selected" : "" %>>Half Sleeve</option>
                <option value="Elbow Sleeve" <%= product.sleeveType === "Elbow Sleeve" ? "selected" : "" %>>Elbow Sleeve</option>
              </select>
              <div id="sleeveTypeError" class="text-danger small"></div>
            </div>

            <div class="mb-2"><label class="form-label">Wash Care</label><input type="text" class="form-control" name="washCare" value="<%= product.washCare %>"></div>
            <div class="mb-2"><label class="form-label">Additional Information</label><textarea class="form-control" name="additionalInfo" rows="2"><%= product.additionalInfo || '' %></textarea></div>
          </div>

          <!-- Actions -->
          <div class="mb-4 d-flex justify-content-center gap-3">
            <button type="button" class="btn btn-secondary px-4" onclick="window.history.back()">Back</button>
            <button type="submit" class="btn btn-primary px-4">Update Product</button>
          </div>
        </form>
      </main>
    </div>
  </div>

  <!-- Cropper Modal -->
  <div id="cropperModal" class="cropper-modal" aria-hidden="true">
    <div class="cropper-modal-content">
      <span id="cropperClose" class="modal-close" aria-label="Close">&times;</span>
      <h5 class="mb-3">Crop Image</h5>
      <img id="cropperImage" src="" alt="Image to crop">
      <div class="cropper-btn-row">
        <button id="cropperCropBtn" type="button" class="btn btn-primary">Crop &amp; Use</button>
        <button id="cropperCancelBtn" type="button" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/cropperjs@1.5.16/dist/cropper.min.js"></script>
  <!-- SweetAlert2 already loaded in head; no need to load again -->

  <script>
document.addEventListener('DOMContentLoaded', function () {

  let cropper = null, currentIndex = 0;

  const inputSelectors = ["#mainImageInput", "#additionalImageInput1", "#additionalImageInput2", "#additionalImageInput3"];
  const previewSelectors = ["#mainImagePreview", "#additionalImagePreview1", "#additionalImagePreview2", "#additionalImagePreview3"];
  const hiddenSelectors = ["#mainCroppedImageData", "#additionalCroppedImageData1", "#additionalCroppedImageData2", "#additionalCroppedImageData3"];

  window.openInput = function (idx) {
    currentIndex = idx;
    document.querySelector(inputSelectors[idx]).click();
  };

  inputSelectors.forEach((sel) => {
    const input = document.querySelector(sel);
    input.addEventListener('change', function (e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (ev) {
        showCropperModal(ev.target.result);
      };
      reader.readAsDataURL(file);
    });
  });

  function showCropperModal(imgSrc) {
    const modal = document.getElementById("cropperModal");
    const cropperImage = document.getElementById("cropperImage");

    if (cropper) {
      cropper.destroy();
      cropper = null;
    }
    cropperImage.src = "";
    cropperImage.onload = null;

    modal.style.display = "flex";
    modal.setAttribute('aria-hidden', 'false');

    setTimeout(() => {
      cropperImage.onload = function () {
        cropper = new Cropper(cropperImage, {
          aspectRatio: 1,
          viewMode: 1,
          autoCropArea: 1,
          movable: true,
          zoomable: false,
          rotatable: false,
          scalable: false,
          dragMode: 'move'
        });
      };
      cropperImage.src = imgSrc;
    }, 50);
  }

  function closeCropper(clearInput = true) {
    if (cropper) {
      cropper.destroy();
      cropper = null;
    }

    const modal = document.getElementById("cropperModal");
    modal.style.display = "none";
    modal.setAttribute('aria-hidden', 'true');

    const cropperImage = document.getElementById("cropperImage");
    cropperImage.onload = null;
    cropperImage.src = "";

    const inp = document.querySelector(inputSelectors[currentIndex]);
    if (inp && clearInput) inp.value = "";
  }

  document.getElementById("cropperClose").addEventListener('click', () => closeCropper(true));
  document.getElementById("cropperCancelBtn").addEventListener('click', () => closeCropper(true));

  document.getElementById("cropperCropBtn").addEventListener('click', function () {
    if (!cropper) return;
    const canvas = cropper.getCroppedCanvas({ width: 800, height: 800 });
    if (!canvas) return;

    const base64 = canvas.toDataURL("image/jpeg", 0.9);
    document.querySelector(previewSelectors[currentIndex]).src = base64;
    document.querySelector(hiddenSelectors[currentIndex]).value = base64;

    canvas.toBlob(function (blob) {
      if (!blob) return;
      const file = new File([blob], "product.jpg", { type: "image/jpeg" });
      const dt = new DataTransfer();
      dt.items.add(file);
      document.querySelector(inputSelectors[currentIndex]).files = dt.files;

      const err = document.getElementById('imageError');
      if (err) err.style.display = 'none';

      closeCropper(false);
    }, "image/jpeg", 0.9);
  });

  const categorySelect = document.getElementById("categorySelect");
  const subcategorySelect = document.getElementById("subcategorySelect");

  categorySelect.addEventListener("change", function () {
    const selectedCategoryId = this.value;
    Array.from(subcategorySelect.options).forEach(option => {
      option.style.display =
        option.value === "" || option.getAttribute("data-category-id") === selectedCategoryId
          ? ""
          : "none";
    });
    subcategorySelect.value = "";
  });

  // ---------------------- FORM VALIDATION ----------------------
  const form = document.getElementById('updateProductForm');
  if (form) {
    form.addEventListener('submit', function (e) {

      let isValid = true;
      const errorFields = [
        'nameError', 'descriptionError', 'categoryError', 'colorError',
        'sleeveTypeError', 'fitTypeError', 'offerPercentError',
        'maxRedeemError', 'variantError', 'imageError'
      ];

      errorFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.innerText = '';
          el.style.display = 'none';
        }
      });

      function showError(id, message) {
        const el = document.getElementById(id);
        el.innerText = message;
        el.style.display = "block";
        isValid = false;
      }

      if (!document.getElementById("name").value.trim()) showError("nameError", "Product Name is required");
      if (!document.getElementById("description").value.trim()) showError("descriptionError", "Description is required");
      if (!document.getElementById("categorySelect").value) showError("categoryError", "Category is required");
      if (!document.getElementById("color").value.trim()) showError("colorError", "Color is required");
      if (!document.getElementById("sleeveType").value) showError("sleeveTypeError", "Sleeve Type is required");
      if (!document.getElementById("fitType").value) showError("fitTypeError", "Fit Type is required");

      const offer = document.getElementById("productOffer").value;
      if (offer !== "" && (offer < 0 || offer > 99)) showError("offerPercentError", "Offer must be between 0 and 99");

      const maxRedeem = document.getElementById("maxRedeem").value;
      if (maxRedeem !== "" && maxRedeem < 0) showError("maxRedeemError", "Max Redeem cannot be negative");

      let variantFilled = false;
      const qtyInputs = document.querySelectorAll('.qty-input');
      const priceInputs = document.querySelectorAll('.price-input');

      for (let i = 0; i < qtyInputs.length; i++) {
        if (qtyInputs[i].value && priceInputs[i].value && priceInputs[i].value > 0) {
          variantFilled = true;
          break;
        }
      }
      if (!variantFilled) showError("variantError", "At least one variant must be provided");

      let hasUncroppedImage = false;
      for (let i = 0; i < inputSelectors.length; i++) {
        const f = document.querySelector(inputSelectors[i]);
        const h = document.querySelector(hiddenSelectors[i]);
        if (f.files.length > 0 && (!h.value || h.value.length < 30)) {
          hasUncroppedImage = true;
        }
      }

      if (hasUncroppedImage) showError("imageError", "Please crop the selected images before submitting.");

      if (!isValid) {
        e.preventDefault();
        document.querySelector('.section-card').scrollIntoView({ behavior: 'smooth' });
      }
    });
  }

}); // END DOMContentLoaded

// Move deleteImage AFTER DOMContentLoaded script and keep it global
function deleteImage(productId, index) {
  // Quick debug to ensure function is called
  console.log('deleteImage called', productId, index);

  Swal.fire({
    title: "Are you sure?",
    text: "This image will be removed.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, delete",
    cancelButtonText: "Cancel"
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/admin/product/${productId}/image/${index}`, {
        method: "DELETE"
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {

          if (index === 0) {
            document.getElementById("mainImagePreview").src =
              "https://dummyimage.com/420x140/e8eaf5/b8bdde.jpg&text=No+Image";
          } else {
            document.getElementById(`additionalImagePreview${index}`).src =
              "https://dummyimage.com/170x140/e8eaf5/b8bdde.jpg&text=No+Image";
          }

          Swal.fire("Deleted!", "Image removed successfully.", "success");
        } else {
          Swal.fire("Error", data.message || "Something went wrong", "error");
        }
      })
      .catch(() => {
        Swal.fire("Error", "Unable to delete image", "error");
      });
    }
  });
}
</script>

</body>
</html>
