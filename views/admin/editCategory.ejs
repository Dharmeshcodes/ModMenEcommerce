<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Category</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 & FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    body { background: #f7f9fb; min-height: 100vh; margin: 0; }
    .edit-content-outer { width: 100vw; margin: 0; padding: 0; background: #f7f9fb; }
    .edit-content-inner { width: 100%; max-width: 1420px; margin: 0; background: #fff; padding: 32px 0 40px 0; border-radius: 0; box-shadow: none; }
    .edit-form-section { width: 98vw; max-width: 1040px; margin: 0 auto; padding: 0; }
    .edit-title { font-size: 2.1rem; font-weight: 700; margin-bottom: 28px; color: #223; letter-spacing: 1px; text-align: left; }
    .img-area-edit { width: 100%; max-width: 900px; margin: 0 auto 20px auto; min-height: 190px; border-radius: 14px; overflow: hidden; display: flex; justify-content: center; align-items: center; background: #e9eefd; position: relative; }
    .img-edit-preview { width: 100%; min-width: 360px; max-width: 100%; height: 230px; object-fit: cover; border-radius: 14px; background: #dee4f4; display: block; }
    .img-upload-btn-edit { position: absolute; top: 13px; right: 22px; padding: 7px 20px; border-radius: 7px; font-size: 1.05rem; background: #2563eb; color: #fff; border: none; z-index: 2; }
    .img-upload-btn-edit:hover { background: #163dae; color: #fff; }
    .edit-row-flex { display: flex; gap: 38px; margin: 26px 0 12px 0; flex-wrap: wrap; width: 100%; }
    .edit-col-flex { flex: 1 1 200px; display: flex; flex-direction: column; max-width: 288px; min-width: 160px; }
    .form-label-edit { font-weight: 600; color: #425176; font-size: 1.08rem; margin-bottom: 4px; margin-top: 7px; }
    .form-input-edit, .desc-edit-box { width: 100%; border-radius: 7px; border: 1.1px solid #e6e7ef; background: #f6f9fe; color: #283246; font-size: 1.14rem; margin-bottom: 7px; padding: 0.62em 1.1em; font-weight: 500; resize: none; }
    .desc-edit-box { min-height: 52px; resize: none; }
    .btn-edit-row { width: 100%; display: flex; justify-content: center; gap: 1.3em; margin-top: 34px; margin-bottom: 5px; flex-wrap: wrap; }
    .btn-edit-cat { padding: 0.74em 2.33em; font-size: 1.09rem; font-weight: 600; border-radius: 8px; }
    .btn-update { background: #2563eb; color: #fff; border: none; }
    .btn-update:hover { background: #163dae; }
    .btn-cancel { background: #dce0e9; color: #192146; border: none; }
    .btn-cancel:hover { background: #b7bed0; color: #182033; }
    .btn-delete { background: #ff3333; color: #fff; border: none; }
    .btn-delete:hover { background: #e00b0b; color: #fff; }
    @media (max-width: 900px) {
      .edit-content-inner { padding: 13px 0 18px 0;}
      .edit-form-section { max-width: 98vw; }
      .img-area-edit { min-height: 80px; }
      .img-edit-preview { height: 110px; }
      .edit-row-flex { gap: 12px; }
    }
    @media (max-width: 600px) {
      .edit-form-section { max-width: 100vw; margin: 0; }
      .edit-col-flex { max-width: 99vw; }
      .edit-row-flex { flex-direction: column; margin: 15px 0 7px 0; }
      .img-area-edit { min-height: 34px; }
      .img-edit-preview { height: 82px; }
      .btn-edit-row { flex-direction: column; gap: 0.9em; }
      .btn-edit-cat { min-width: 80vw; }
      .edit-title { font-size: 1.19rem; }
    }
  </style>
</head>
<body>
<%- include('../partials/admin/header') %>
<div class="container-fluid px-0 edit-content-outer">
  <div class="row gx-0">
    <%- include('../partials/admin/sidebar') %>
    <main class="col-md-10 ms-sm-auto col-lg-10 px-0">
      <div class="edit-content-inner">
        <div class="edit-form-section">
          <% if (typeof messages !== 'undefined' && messages.error_msg) { %>
            <div class="alert alert-danger py-2 mb-3 d-flex align-items-center" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <div><%= messages.error_msg %></div>
            </div>
          <% } %>
          <% if (typeof messages !== 'undefined' && messages.success_msg) { %>
            <div class="alert alert-success py-2 mb-3 d-flex align-items-center" role="alert">
              <i class="fas fa-check-circle me-2"></i>
              <div><%= messages.success_msg %></div>
            </div>
          <% } %>
          <form method="POST"
              enctype="multipart/form-data"
              action="/admin/editCategory/<%= category._id %>"
              autocomplete="off"
              novalidate>
            

            <div class="img-area-edit">
              <img 
                src="<%= category.image || 'https://dummyimage.com/800x230/ededed/888888.jpg&text=No+Image' %>"
                alt="Category Image" 
                class="img-edit-preview" 
                id="catImagePreview"
              />
              <input 
                type="file" 
                name="image" 
                id="imageInput" 
                accept="image/*" 
                style="display: none;"
                onchange="showEditImagePreview(this)"
              />
              <button type="button" class="img-upload-btn-edit" onclick="document.getElementById('imageInput').click();">
                Change Image
              </button>
              <div class="text-danger small" id="imageError"></div>
            </div>

            <div class="edit-row-flex">
              <div class="edit-col-flex">
                <label for="categoryOffer" class="form-label-edit">Offer (%)</label>
                <input 
                  type="number"
                  min="0"
                  max="100"
                  step="0.01"
                  class="form-input-edit"
                  id="categoryOffer"
                  name="offer[offerPercentage]"
                  value="<%= category.offer ? category.offer.offerPercentage : '' %>"
                  placeholder="Offer..."
                />
                <div class="text-danger small" id="offerPercentError"></div>
              </div>
              <div class="edit-col-flex">
                <label for="maxRedeemable" class="form-label-edit">Max Redeemable</label>
                <input 
                  type="number"
                  min="0"
                  class="form-input-edit"

                  id="maxRedeemable"
                  name="offer[maxRedeem]"
                  value="<%= category.offer ? category.offer.maxRedeem : '' %>"
                  placeholder="Max Redeem..."
                />
                <div class="text-danger small" id="maxRedeemError"></div>
              </div>
            </div>

            <div class="edit-row-flex">
              <div class="edit-col-flex">
                <label for="startDate" class="form-label-edit">Offer Start Date</label>
                <input 
                  type="date"
                  class="form-input-edit"
                  id="startDate"
                  name="offer[startDate]"
                  value="<%= category.offer && category.offer.startDate ? new Date(category.offer.startDate).toISOString().slice(0,10) : '' %>"
                />
                  
              </div>
              <div class="edit-col-flex">
                <label for="validUntil" class="form-label-edit">Offer Valid Until</label>
                <input 
                  type="date"
                  class="form-input-edit"
                  id="validUntil"
                  name="offer[validUntil]"
                  value="<%= category.offer && category.offer.validUntil ? new Date(category.offer.validUntil).toISOString().slice(0,10) : '' %>"
                />
              </div>
            </div>

            <label for="name" class="form-label-edit">Category Name</label>
            <input
              type="text"
              id="name"
              name="name"
              class="form-input-edit"
              required
              value="<%= category.name || '' %>"
              placeholder="e.g. Formals"
            />
              <div class="text-danger small" id="nameError"></div>

            <label class="form-label-edit">Subcategories</label>
            <div>
              <% if (category.subcategories && category.subcategories.length) { %>
                <% category.subcategories.forEach(function(subcat) { %>
                  <span class="subcategory-badge-edit"><%= subcat.name %></span>
                <% }); %>
              <% } else { %>
                <span class="text-muted">No subcategories</span>
              <% } %>
              <div class="form-text mt-1">Manage subcategories <a href="/admin/subcategory">here</a>.</div>
            </div>

            <label for="description" class="form-label-edit">Description</label>
            <textarea
              id="description"
              name="description"
              rows="2"
              class="desc-edit-box"
              placeholder="Category description..."><%= category.description || '' %></textarea>
                <div class="text-danger small" id="descriptionError"></div>

            <div class="btn-edit-row">
              <button type="submit" class="btn btn-update btn-edit-cat">
                Update
              </button>
              <a href="/admin/category" class="btn btn-cancel btn-edit-cat">
                Cancel
              </a>
              <button type="button" class="btn btn-delete btn-edit-cat" onclick="softDeleteCategory('<%= category._id %>')">Delete</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function showEditImagePreview(input) {
    const preview = document.getElementById('catImagePreview');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = e => { preview.src = e.target.result; };
      reader.readAsDataURL(input.files[0]);
    }
  }
  
  function softDeleteCategory(categoryId) {
    Swal.fire({
      title: 'Delete Category?',
      text: 'Are you sure you want to delete this category?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/admin/deleteCategory/${categoryId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isDeleted: true })
        })
        .then(res => res.json())
        .then(data => {
          if(data.success) {
            Swal.fire('Deleted!', data.message, 'success').then(() => {
              window.location.href = '/admin/category';
            });
          } else {
            Swal.fire('Error!', data.message || 'Failed to delete category', 'error');
          }
        })
        .catch(() => {
          Swal.fire('Error!', 'Server error occurred', 'error');
        });
      }
    });
  }


document.querySelector("form").addEventListener("submit", function(e) {

  document.getElementById("nameError").innerText = "";
  document.getElementById("descriptionError").innerText = "";
  document.getElementById("offerPercentError").innerText = "";
  document.getElementById("maxRedeemError").innerText = "";
  document.getElementById("imageError").innerText = "";

  let isValid = true;

  const name = document.getElementById("name").value.trim();
  if (name.length < 3) {
    document.getElementById("nameError").innerText = "Category name must have at least 3 characters.";
    isValid = false;
  }


  const description = document.getElementById("description").value.trim();
  if (description.length < 3) {
    document.getElementById("descriptionError").innerText = "Description must have at least 3 characters.";
    isValid = false;
  }

  const offerValue = document.getElementById("categoryOffer").value.trim();
  if (offerValue !== "") {
    const offerNum = Number(offerValue);
    if (offerNum < 1 || offerNum > 100) {
      document.getElementById("offerPercentError").innerText = "Offer must be between 1 and 100.";
      isValid = false;
    }
  }


  const maxRedeemValue = document.getElementById("maxRedeemable").value.trim();
  if (maxRedeemValue !== "" && Number(maxRedeemValue) < 0) {
    document.getElementById("maxRedeemError").innerText = "Max redeem value cannot be negative.";
    isValid = false;
  }

 
  const imageInput = document.getElementById("imageInput");
  if (imageInput.files.length > 0) {
    const file = imageInput.files[0];
    const allowedTypes = ["image/jpeg", "image/png", "image/jpg", "image/webp"];

    if (!allowedTypes.includes(file.type)) {
      document.getElementById("imageError").innerText = "Only JPG, JPEG, PNG, and WEBP images are allowed.";
      isValid = false;
    }

    if (file.size > 2 * 1024 * 1024) {
      document.getElementById("imageError").innerText = "Image size must be less than 2MB.";
      isValid = false;
    }
  }

  if (!isValid) {
    e.preventDefault();
  }
});

</script>
</body>
</html>
