<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>My Cart | ModMen</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{margin-top:20px;}
.cart-scroll-box{
    max-height:420px;
    overflow-y:auto;
    padding-right:15px;
}
.cart-scroll-box::-webkit-scrollbar{width:12px;}
.cart-scroll-box::-webkit-scrollbar-track{
    background:#d9d9d9;
    border-radius:10px;
}
.cart-scroll-box::-webkit-scrollbar-thumb{
    background:black;
    border-radius:10px;
}
.cart-item-box{
    border-bottom:3px solid #e5e5e5;
    border-left:3px solid #e5e5e5;
    padding:20px 10px;
}
.qty-control{
    display:flex;
    align-items:center;
    border:1px solid #bbb;
    border-radius:8px;
    overflow:hidden;
    width:115px;
    height:40px;
}
.qty-left, .qty-right{
    width:35px;height:100%;
    display:flex;
    align-items:center;justify-content:center;
    cursor:pointer;
}
.qty-left{background:white;}
.qty-right{background:black;color:white;}
.qty-num{width:40px;text-align:center;font-weight:600;}
.summary-box{
    border:2px solid #1e90ff;
    border-radius:8px;
    padding:20px;
    min-height:350px;
}
.price-strike{text-decoration:line-through;font-size:14px;opacity:.7;}
.save-text{color:#00b300;font-weight:600;font-size:15px;}

/* Disable qty buttons when out of stock */
.disabled-btn {
    pointer-events: none;
    opacity: 0.4;
}
</style>
</head>

<body>

<%- include('../partials/user/header') %>

<div class="container mt-3">

    <h3 class="fw-bold mb-2">CART</h3>

    <div class="row mt-1">

        <!-- LEFT CART ITEMS -->
        <div class="col-lg-8">

            <div class="d-flex justify-content-end mb-2">
                <button id="emptyCartBtn" class="btn btn-danger btn-sm">Empty my Cart</button>
            </div>

            <div class="cart-scroll-box" id="cartArea">

                <% if(items && items.length > 0){ %>
                <% items.forEach(item => { %>

                <!-- MAIN CART ITEM BOX -->
                <div class="cart-item-box shadow-sm"
                     data-product="<%= item.productId._id %>"
                     data-size="<%= item.size %>"
                     data-color="<%= item.color %>">

                    <div class="row">

                        <div class="col-3 d-flex align-items-center">
                            <img src="<%= item.productId.images[0].url %>" 
                                 class="img-fluid rounded" style="width:140px;height:auto;" alt="">
                        </div>

                        <div class="col-6">
                            <h5 class="fw-semibold"><%= item.productId.name %></h5>

                            <div class="d-flex align-items-center gap-2">
                                <span class="fw-bold fs-5">₹<%= item.salePrice.toFixed(2) %></span>
                                <span class="price-strike">₹<%= item.variantPrice.toFixed(2) %></span>

                                <% if(item.productId.stock === 0){ %>
                                    <span class="badge bg-danger ms-2">OUT OF STOCK</span>
                                <% } %>
                            </div>

                            <div class="save-text">Save ₹<%= (item.variantPrice-item.salePrice).toFixed(2) %></div>

                            <div class="mt-2">
                                <small>size: <b><%= item.size %></b></small>
                                <small class="ms-3">color: <b><%= item.color %></b></small>
                            </div>
                        </div>

                        <div class="col-3 text-end">

                            <div class="qty-control mb-2 ms-auto">

                                <div class="qty-left decrease-btn <%= item.productId.stock === 0 ? 'disabled-btn' : '' %>">
                                    <i class="fa-solid fa-minus"></i>
                                </div>

                                <div class="qty-num item-qty"><%= item.quantity %></div>

                                <div class="qty-right increase-btn <%= item.productId.stock === 0 ? 'disabled-btn' : '' %>">
                                    <i class="fa-solid fa-plus"></i>
                                </div>

                            </div>

                            <button class="btn btn-dark btn-sm w-75 remove-btn">Remove</button>

                        </div>

                    </div>
                </div>

                <% }) %>
                <% } else { %>
                    <h5>Your cart is empty.</h5>
                <% } %>

            </div>
        </div>

        <!-- SUMMARY BOX -->
        <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="summary-box">
                <h5 class="fw-bold mb-3">Cart Summary</h5>

                <div class="d-flex justify-content-between mb-2">
                    <span>Total MRP:</span>
                    <span id="grandTotal">₹<%= grandTotal.toFixed(2) %></span>
                </div>

                <div class="d-flex justify-content-between mb-2">
                    <span>Tax (GST):</span>
                    <span id="taxAmount">₹<%= tax.toFixed(2) %></span>
                </div>

                <div class="d-flex justify-content-between mb-2">
                    <span>Shipping:</span>
                    <span id="shippingCharge">₹<%= shippingCharge.toFixed(2) %></span>
                </div>

                <hr>

                <div class="d-flex justify-content-between fw-bold fs-5">
                    <span>Payable Total:</span>
                    <span id="payableTotal">₹<%= payableTotal.toFixed(2) %></span>
                </div>
            </div>
        </div>

    </div>

    <div class="text-center mt-5 mb-4">
        <a href="/user/checkout-address" class="btn btn-dark px-5 py-2 mb-3 w-50" id="checkoutBtn">Proceed to checkout</a><br>
        <a href="/shop" class="btn btn-outline-dark px-5 py-2 w-50">Continue Shopping</a>
    </div>

</div>

<%- include('../partials/user/footer') %>

<script>

//////////////////// UPDATE TOTALS ////////////////////
function updateTotals(t){
    document.getElementById("grandTotal").innerText = "₹" + t.grandTotal.toFixed(2);
    document.getElementById("shippingCharge").innerText = "₹" + t.shippingCharge.toFixed(2);
    document.getElementById("payableTotal").innerText = "₹" + t.payableTotal.toFixed(2);
}

//////////////////// INCREASE ////////////////////
document.querySelectorAll(".increase-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
        const box = btn.closest(".cart-item-box");
        const productId = box.dataset.product;
        const size = box.dataset.size;
        const color = box.dataset.color;

        const res = await fetch("/user/incresecartqty", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ productId, size, color })
        });

        const data = await res.json();

        if(data.success){
            box.querySelector(".item-qty").innerText = data.itemQuantity;
            updateTotals(data.updatedTotal);
        } else {
            Swal.fire("Error", data.message, "error");
        }
    });
});

//////////////////// DECREASE ////////////////////
document.querySelectorAll(".decrease-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
        const box = btn.closest(".cart-item-box");
        const productId = box.dataset.product;
        const size = box.dataset.size;
        const color = box.dataset.color;

        const res = await fetch("/user/decreasecartqty", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ productId, size, color })
        });

        const data = await res.json();

        if(data.success){
            if(data.itemRemoved){
                box.remove();
            } else {
                box.querySelector(".item-qty").innerText = data.itemQuantity;
            }
            updateTotals(data.updatedTotal);
        } else {
            Swal.fire("Error", data.message, "error");
        }
    });
});

//////////////////// REMOVE ITEM ////////////////////
document.querySelectorAll(".remove-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
        const box = btn.closest(".cart-item-box");
        const productId = box.dataset.product;
        const size = box.dataset.size;
        const color = box.dataset.color;

        const res = await fetch("/user/removecartitem", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ productId, size, color })
        });

        const data = await res.json();

        if (data.success) {
            box.remove();
            updateTotals(data.updatedTotal);

            Swal.fire({
                title: "Removed!",
                text: "Item removed from cart.",
                icon: "success",
                timer: 1500,
                showConfirmButton: false
            });

        } else {
            Swal.fire("Error", data.message, "error");
        }
    });
});

//////////////////// EMPTY CART ////////////////////
document.getElementById("emptyCartBtn").addEventListener("click", async () => {
    const res = await fetch("/user/emptycart", { method: "POST" });
    const data = await res.json();

    if(data.success){
        document.getElementById("cartArea").innerHTML = `
            <h5 class="text-center mt-3">Your cart is empty.</h5>
        `;

        updateTotals({
            grandTotal: 0,
            shippingCharge: 0,
            payableTotal: 0
        });

        Swal.fire({
            title: "Cart Emptied",
            text: "Your cart is now empty.",
            icon: "success",
            timer: 1500,
            showConfirmButton: false
        });

    } else {
        Swal.fire("Error", data.message, "error");
    }
});


</script>

<!-- GET CART PAGE ERROR SWAL -->
<% if (typeof errorMessage !== "undefined" && errorMessage) { %>
<script>
Swal.fire({
    icon: "info",
    title: "Notice",
    text: "<%= errorMessage %>",
});
</script>
<% } %>

</body>
</html>
