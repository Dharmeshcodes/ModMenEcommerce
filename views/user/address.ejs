<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Delivery Address | ModMen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    body { background: #fafafa; overflow-x: hidden; }

    /* Sidebar */
    .sidebar-box {
      background: #fff; border-radius: 22px;
      box-shadow: 0 10px 30px rgba(60,60,60,0.10);
      padding: 35px 25px; margin-top: 40px; margin-right: 20px;
      border: 2.3px solid #3194fa1f; min-height: 650px;
    }
    .sidebar-avatar {
      width: 70px; height: 70px; background: #000; border-radius: 50%;
      display: inline-block; margin-bottom: 10px;
    }
    .sidebar-username { font-size: 1.2rem; font-weight: 500; }

    .sidebar-menu a {
      background: transparent !important; border: none !important;
      padding: 13px 4px; font-size: 1.05rem; color: #111;
      display: flex; align-items: center; gap: 13px;
    }
    .sidebar-menu a i { width: 23px; text-align: center; }

    /* Main content */
    .main-area { margin-top: 25px; }

    .main-content-box {
      background: #fff; border-radius: 21px;
      box-shadow: 0 10px 24px rgba(60,60,60,0.09);
      border: 2.5px solid #3194fa36;
      padding: 30px; max-width: 820px; margin-bottom: 60px;
    }

    .delivery-title { font-size: 1.45rem; font-weight: 550; margin-bottom: 20px; }

    .address-row {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1.8rem;
    }

    .address-card {
      background: #fff; border-radius: 15px;
      box-shadow: 0 4px 16px rgba(20,20,20,0.07);
      border: 1.7px solid #e7e7e7;
      padding: 18px 16px 37px 20px; position: relative;
    }

    .address-edit {
      position: absolute; top: 13px; right: 14px;
      background: transparent; border: none; cursor: pointer;
      font-size: 1.2rem; color: #232323;
    }

    .address-default {
      position: absolute; left: 15px; bottom: 11px;
      font-size: 0.88rem; background: #f4f4f4;
      padding: 2px 10px; border-radius: 5px;
    }

    .address-delete {
      position: absolute; bottom: 11px; right: 15px;
      font-size: 0.87rem; background: #232323; color: #fff;
      border: none; border-radius: 7px; padding: 2px 15px;
      cursor: pointer;
    }
    .address-delete:hover { background: #0d6efd; }

    /* Pagination */
    .pagination-link {
      display: inline-flex; justify-content: center; align-items: center;
      width: 32px; height: 32px; border-radius: 50%;
      margin: 0 5px; font-weight: 500; text-decoration: none;
    }

    .add-new-btn { margin-top: 35px; text-align: center; }
    .add-new-btn button {
      background: #000; color: white; padding: 10px 42px;
      border: none; border-radius: 7px; font-size: 1.05rem;
    }
  </style>
</head>

<body>

<%- include('../partials/user/header') %>

<div class="container-fluid">
  <div class="row">

    <!-- Sidebar -->
    <div class="col-lg-3 col-md-4">
      <div class="sidebar-box text-center">
        <div class="sidebar-profile position-relative d-flex align-items-center justify-content-center mb-3" style="flex-direction: column;">
            <img 
              src="<%= user.profileImage ? user.profileImage + '?w=70&h=70&c=fill' : '/images/default-avatar.png' %>" 
              alt="Profile" 
              class="rounded-circle mb-2"
              style="width:70px; height:70px; object-fit:cover;">
            
            <span class="sidebar-username"><%= user.fullName %></span>

            
          </div>


        <div class="sidebar-menu list-group list-group-flush mt-3">
          <a href="/user/profile" class="list-group-item"><i class="fa-solid fa-user"></i> My Profile</a>
          <a href="/user/address" class="list-group-item"><i class="fa-solid fa-location-dot"></i> My Address</a>
          <a href="/user/order" class="list-group-item"><i class="fa-solid fa-bag-shopping"></i> My Order</a>
          <a href="/user/wishlist" class="list-group-item"><i class="fa-solid fa-heart"></i> My Wishlist</a>
          <a href="/user/wallet" class="list-group-item"><i class="fa-solid fa-wallet"></i> My Wallet</a>
          <a href="/user/coupen" class="list-group-item"><i class="fa-solid fa-ticket"></i> My Coupon</a>
          <a href="/user/change-password" class="list-group-item"><i class="fa-solid fa-key"></i> Change Password</a>
          <a href="/user/logout" class="list-group-item"><i class="fa-solid fa-arrow-right-from-bracket"></i> Log Out</a>
          <a href="/user/referral-code" class="list-group-item"><i class="fa-solid fa-user-plus"></i> Referral Code</a>
        </div>
      </div>
    </div>

    <!-- Main content -->
    <div class="col-lg-9 col-md-8 main-area">

      <div class="main-content-box">
        <div class="delivery-title">Delivery Address</div>

        <div class="address-row">
          <% if (addresses && addresses.length) { %>
            <% addresses.forEach(addr => { %>
              <div class="address-card">
                <button class="address-edit" onclick="window.location='/user/updateAddress/<%= addr._id %>'">
                  <i class="fa-solid fa-pen-to-square"></i>
                </button>

                <div class="address-details">
                  <strong><%= addr.fullName %></strong>
                  <p><%= addr.houseNo %>, <%= addr.landMark %></p>
                  <p><%= addr.district %>, <%= addr.city %></p>
                  <p><%= addr.state %> - <%= addr.pincode %></p>
                  <p><%=addr.phone %></p>
                </div>

                <% if (addr.isDefault) { %>
                  <span class="address-default">Default</span>
                <% } %>

                <button class="address-delete delete-btn" data-id="<%= addr._id %>">
                    DELETE
                  </button>

              </div>
            <% }) %>
          <% } else { %>
            <p>No saved addresses yet.</p>
          <% } %>
        </div>

        <!-- SAFE PAGINATION -->
        <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
          <div class="d-flex justify-content-center mt-4">
            <% for (let i = 1; i <= totalPages; i++) { %>
              <a href="/user/address?page=<%= i %>" 
                 class="pagination-link"
                 style="
                  background: <%= (currentPage === i) ? '#000' : '#e5e5e5' %>; 
                  color: <%= (currentPage === i) ? '#fff' : '#000' %>;
                 ">
                <%= i %>
              </a>
            <% } %>
          </div>
        <% } %>

        <div class="add-new-btn">
          <button onclick="window.location='/user/addAddress'">Add New Address</button>
        </div>

      </div>
    </div>

  </div>
</div>

<%- include('../partials/user/footer') %>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", function () {

      const addressId = this.dataset.id;

      Swal.fire({
        title: "Are you sure?",
        text: "Do you want to delete this address?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Delete",
        cancelButtonText: "Cancel",
        confirmButtonColor: "#d33"
      }).then((result) => {

        if (result.isConfirmed) {

          fetch(`/user/deleteAddress/${addressId}`, {
            method: "DELETE"
          })
          .then(res => res.json())
          .then(data => {

            if (data.success) {
              Swal.fire("Deleted!", data.message, "success")
                .then(() => location.reload());
            } else {
              Swal.fire("Error", data.message, "error");
            }

          });

        }

      });

    });
  });

  
</script>

</body>
</html>
