<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>
    <% if (step === 'forgot') { %>
      Forgot Password
    <% } else if (step === 'otp') { %>
      Enter OTP
    <% } else if (step === 'reset') { %>
      Reset Password
    <% } %>
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #fff;
      min-height: 100vh;
    }
    .centered-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .custom-form-box {
      max-width: 370px;
      width: 100%;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      padding: 0;
      box-shadow: none;
    }
    .form-label-custom {
      font-weight: 400;
      font-size: 1rem;
      color: #333;
    }
    .custom-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 24px;
    }
    .custom-btn {
      background: #000;
      color: #fff;
      border-radius: 6px;
      font-size: 1rem;
      padding: 0.7rem 0;
      width: 100%;
      border: none;
      margin-top: 18px;
    }
    .custom-btn:active,
    .custom-btn:focus {
      background: #303030;
      color: #fff;
      box-shadow: none;
      border: none;
    }
    .otp-input-box {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 18px;
    }
    .otp-input {
      width: 240px;
      height: 48px;
      text-align: center;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1.5rem;
      outline: none;
      background: #fff;
      color: #111;
      transition: border .2s;
      letter-spacing: 8px;
    }
    .otp-input:focus {
      border-color: #888;
    }
    .resend-link {
      font-size: 0.95rem;
      color: #000;
      font-weight: 500;
      text-decoration: none;
      margin-left: 5px;
      cursor: pointer;
    }
    .small-text {
      font-size: 0.97rem;
      color: #888;
      margin-bottom: 8px;
    }
    @media (max-width: 576px) {
      .custom-form-box {
        padding: 8px;
        max-width: 95vw;
      }
      .otp-input {
        width: 200px;
        height: 46px;
        font-size: 1.2rem;
      }
      .custom-title { font-size: 1.28rem; }
    }
  </style>
</head>
<body>
  <div class="centered-container">
    <div class="custom-form-box">
      <% if (error_msg) { %>
        <div class="alert alert-danger px-3 py-2 mb-3" role="alert">
          <%= error_msg %>
        </div>
      <% } %>
      <% if (success_msg) { %>
        <div class="alert alert-success px-3 py-2 mb-3" role="alert">
          <%= success_msg %>
        </div>
      <% } %>

      <!-- Forgot Password Page -->
      <% if (step === 'forgot') { %>
        <div class="mb-4 text-center">
          <div class="custom-title">Forgot Password?</div>
          <div class="form-label-custom mb-3">Enter your registered email</div>
        </div>
        <form method="POST" action="/user/forgot-password" id="emailForm">
          <input 
            type="email" 
            name="email" 
            id="email"
            class="form-control mb-3 px-3 py-2"
            value="<%= typeof userEmail !== 'undefined' ? userEmail : '' %>" 
            placeholder="helloworld@gmail.com" 
            style="border-radius: 8px; font-size: 1rem; border:1.5px solid #eee; box-shadow:none;"
            required
          >
          <button type="submit" class="custom-btn">Verify Email</button>
        </form>
      <% } %>

      <!-- OTP Verification Page -->
      <% if (step === 'otp') { %>
        <div class="mb-4 text-center">
          <div class="custom-title">Enter the OTP</div>
          <div class="small-text mb-2">
            We've sent an activation code to 
            <span style="font-weight:500;color:#111;">
              <%= typeof otpEmail !== 'undefined' ? otpEmail : 'your email' %>
            </span>
          </div>
        </div>
        <form method="POST" action="/user/forgot-password/verify-otp" id="otpForm">
          <div class="otp-input-box mb-2">
            <input
              type="text"
              name="otp"
              maxlength="6"
              class="otp-input"
              autocomplete="off"
              required
              inputmode="numeric"
              pattern="[0-9]*"
              placeholder="Enter 6-digit OTP"
            />
          </div>
          <div class="small-text mb-2 text-center">
            Send code again <span id="timer">00:30</span>
          </div>
          <div class="small-text mb-3 text-center">
            I didn't receive a code 
            <a class="resend-link" id="resendOtp">Resend</a>
          </div>
          <button type="submit" class="custom-btn">Verify</button>
        </form>
      <% } %>

      <!-- Reset Password Page -->
      <% if (step === 'reset') { %> 
        <div class="mb-4 text-center">
          <div class="custom-title">Reset Password</div>
        </div>
        <form method="POST" action="/user/forgot-password/reset" id="resetForm">
          <input 
            type="password" 
            name="newPassword" 
            class="form-control mb-3 px-3 py-2"
            placeholder="Enter new password" 
            style="border-radius: 8px; font-size: 1rem; border:1.5px solid #eee; box-shadow:none;"
            required
          >
          <input 
            type="password" 
            name="confirmPassword" 
            class="form-control mb-3 px-3 py-2"
            placeholder="Confirm new password" 
            style="border-radius: 8px; font-size: 1rem; border:1.5px solid #eee; box-shadow:none;"
            required
          >
          <button type="submit" class="custom-btn">Reset Password</button>
        </form>
      <% } %>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    const emailForm = document.getElementById("emailForm");
    if (emailForm) {
      emailForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value;
        try {
          const response = await fetch("/user/forgot-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email })
          });
          const data = await response.json();
          if (data.success_msg) {
            Swal.fire({
              icon: "success",
              title: "Success",
              text: data.success_msg
            }).then(() => {
              window.location.href = "/user/forgot-password/otp";
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: data.error_msg || "Failed to send OTP. Please try again."
            });
          }
        } catch (error) {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "An error occurred. Please try again later."
          });
        }
      });
    }

    const otpForm = document.getElementById("otpForm");
    if (otpForm) {
      otpForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const otp = otpForm.querySelector('input[name="otp"]').value;
        try {
          const response = await fetch("/user/forgot-password/verify-otp", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ otp })
          });
          const data = await response.json();
          if (data.success_msg) {
            Swal.fire({
              icon: "success",
              title: "Success",
              text: data.success_msg
            }).then(() => {
              window.location.href = "/user/forgot-password/reset";
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: data.error_msg || "Invalid OTP. Please try again."
            });
          }
        } catch (error) {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "OTP verification failed. Please try again later."
          });
        }
      });
    }

    const resetForm = document.getElementById("resetForm");
    if (resetForm) {
      resetForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const newPassword = resetForm.querySelector('input[name="newPassword"]').value;
        const confirmPassword = resetForm.querySelector('input[name="confirmPassword"]').value;
        const strongRegex = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*])[A-Za-z\d!@#$%^&*]{8,}$/;
        if (!strongRegex.test(newPassword)) {
          Swal.fire({
            icon: "error",
            title: "Invalid Password",
            text: "Password must be at least 8 characters, contain one uppercase letter, one number, and one symbol."
          });
          return;
        }
        if (newPassword !== confirmPassword) {
          Swal.fire({
            icon: "error",
            title: "Passwords Do Not Match",
            text: "Both passwords must match."
          });
          return;
        }
        try {
          const response = await fetch("/user/forgot-password/reset", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ newPassword, confirmPassword })
          });
          const data = await response.json();
          if (data.success_msg) {
            Swal.fire({
              icon: "success",
              title: "Success",
              text: data.success_msg
            }).then(() => {
              window.location.href = "/user/login";
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: data.error_msg || "Failed to reset password. Please try again."
            });
          }
        } catch (error) {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "An error occurred. Please try again later."
          });
        }
      });
    }

    const resendOtp = document.getElementById("resendOtp");
    if (resendOtp) {
      resendOtp.addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          const response = await fetch("/user/forgot-password/resend-otp", {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
          const data = await response.json();
          if (data.success_msg) {
            Swal.fire({
              icon: "success",
              title: "Success",
              text: data.success_msg
            });
            // Reset timer
            const timerSpan = document.getElementById("timer");
            const resendLink = document.getElementById("resendOtp");
            const otpInput = document.querySelector('input[name="otp"]');
            if (timerSpan && resendLink && otpInput) {
              resendLink.style.pointerEvents = "none";
              resendLink.style.opacity = 0.5;
              otpInput.disabled = false;
              let timer = 30;
              timerSpan.textContent = `00:${timer < 10 ? "0" + timer : timer}`;
              const countdown = setInterval(() => {
                timer--;
                timerSpan.textContent = `00:${timer < 10 ? "0" + timer : timer}`;
                if (timer <= 0) {
                  clearInterval(countdown);
                  resendLink.style.pointerEvents = "auto";
                  resendLink.style.opacity = 1;
                  otpInput.disabled = true;
                }
              }, 1000);
            }
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: data.error_msg || "Failed to resend OTP."
            });
          }
        } catch (error) {
          console.error("Error in resendOtp:", error);
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "An error occurred while resending OTP."
          });
        }
      });
    }

    if (document.getElementById("otpForm")) {
      const timerSpan = document.getElementById("timer");
      const resendLink = document.getElementById("resendOtp");
      const otpInput = document.querySelector('input[name="otp"]');
      if (timerSpan && resendLink && otpInput) {
        resendLink.style.pointerEvents = "none";
        resendLink.style.opacity = 0.5;
        otpInput.disabled = false;
        let timer = 30;
        timerSpan.textContent = `00:${timer < 10 ? "0" + timer : timer}`;
        const countdown = setInterval(() => {
          timer--;
          timerSpan.textContent = `00:${timer < 10 ? "0" + timer : timer}`;
          if (timer <= 0) {
            clearInterval(countdown);
            resendLink.style.pointerEvents = "auto";
            resendLink.style.opacity = 1;
            otpInput.disabled = true;
          }
        }, 1000);
      }
    }
  </script>
</body>
</html>